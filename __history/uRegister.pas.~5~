unit uRegister;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Data.DB, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, Vcl.Grids, Vcl.DBGrids, Vcl.ComCtrls, UTiposClass, UBaseIntf;

type
  TFRegister = class(TForm)
    StatusBar: TStatusBar;
    pnlGrid: TPanel;
    dbgrdMain: TDBGrid;
    pnlData: TPanel;
    pnlButton: TPanel;
    btnPrevious: TSpeedButton;
    btnNext: TSpeedButton;
    btnNew: TSpeedButton;
    btnEdit: TSpeedButton;
    btnSave: TSpeedButton;
    btnUndo: TSpeedButton;
    btnErase: TSpeedButton;
    dsMain: TDataSource;
    btnClose: TSpeedButton;
    bevel1: TBevel;
    bevelClose: TBevel;
    lblNameForm: TLabel;
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormCreate(Sender: TObject);
    procedure FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure btnPreviousClick(Sender: TObject);
    procedure btnNextClick(Sender: TObject);
    procedure btnNewClick(Sender: TObject);
    procedure btnEditClick(Sender: TObject);
    procedure btnSaveClick(Sender: TObject);
    procedure btnUndoClick(Sender: TObject);
    procedure btnEraseClick(Sender: TObject);
    procedure btnCloseClick(Sender: TObject);
  private
    { Private declarations }
    FStatus: TStatus;
    procedure SetStatus(Value: TStatus);
    function  GetDataSetInstantiated: Boolean;

    procedure RefreshDataset;
    function  GetRecordQuantity: Integer;
    procedure SetRecordQuantity;
    procedure ConfirmSave;

    procedure CheckDatasetPosition;
    procedure OnAfterScroll(DataSet: TDataSet);
    procedure OnBeforeScroll(DataSet: TDataSet);

    procedure PreviousRecord;
    procedure NextRecord;
    procedure NewRecord;
    procedure EditRecord;
    procedure SaveRecord;
    procedure UndoRecord;
    procedure EraseRecord;

    procedure EnableOnStart;
    procedure EnableOnInsert;
    procedure EnableOnEdit;
    procedure EnableOnSave;
    procedure EnableOnUndo;
    procedure EnableOnErase;
    procedure EnableOnSearch;
  public
    { Public declarations }
  protected
    function  GetStatus: TStatus;
    procedure MapDataSetToFields(oDataSet: TDataSet); virtual; abstract;
  end;

var
  FRegister: TFRegister;

implementation

uses Mask;

{$R *.dfm}

procedure TFRegister.FormCreate(Sender: TObject);
begin
  SetStatus(stNavegando);

  EnableOnStart;
  SetQtdeRegistros;
end;

procedure TFRegister.SetStatus(Value: TStatus);
begin
  FStatus := Value;
end;

procedure TFRegister.btnNewClick(Sender: TObject);
begin
  NovoRegistro;
end;

procedure TFRegister.btnSaveClick(Sender: TObject);
begin
  SalvarRegistro;
end;

procedure TFRegister.SalvarRegistro;
var
  stStatusAnterior: TStatus;
begin
  HabilitaNoSalvar;

  stStatusAnterior := GetStatus;
  SetStatus(stNavegando);

  if (GetDataSetInstanciado) then
  begin
    RefreshDataset;

    if (stStatusAnterior = stInserindo) then
      dsPrincipal.DataSet.Last;
  end;

  SetQtdeRegistros;
end;

procedure TFRegister.btnUndoClick(Sender: TObject);
begin
  CancelarAlteracao;
end;

procedure TFRegister.btnEditClick(Sender: TObject);
begin
  EditarRegistro;
end;

function TFRegister.GetDataSetInstanciado: Boolean;
begin
  Result := Assigned(dsPrincipal.DataSet);
end;


procedure TFRegister.btnCloseClick(Sender: TObject);
begin
  Close;
end;

procedure TFRegister.btnPreviousClick(Sender: TObject);
begin
  PreviousRegister;

  SetQtdeRegistros;
end;

procedure TFRegister.btnEraseClick(Sender: TObject);
begin
  ApagarRegistro;
  SetStatus(stNavegando);
  SetQtdeRegistros;
end;

procedure TFRegister.btnNextClick(Sender: TObject);
begin
  ProximoRegistro;

  SetQtdeRegistros;
end;

procedure TFRegister.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  if (dsPrincipal.State in [dsInsert, dsEdit]) then
    ConfirmaSalvar
  else if (GetQtdeRegistros > 0) then
  begin
    if MessageDlg('Deseja realmente fechar esta tela ?', mtConfirmation, [mbYes, mbNo], 0) = mrNo then
      Abort;
  end;
end;

procedure TFRegister.FormKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if (key = vk_Escape) then
    Close;
end;

procedure TFRegister.RefreshDataset;
begin
  if (GetDataSetInstanciado) then
    try
      Screen.Cursor := crHourGlass;
      try
        dsPrincipal.DataSet.Refresh;
      except
        on e: Exception do
          raise Exception.Create('Houve uma falha ao tentar recuperar os dados da tabela.' + sLineBreak +
                                 'Mensagem original: ' + e.Message);
      end;
    finally
      Screen.Cursor := crDefault;
    end;
end;

function TFRegister.GetQtdeRegistros: Integer;
begin
  if (GetDataSetInstanciado) then
    Result := dsPrincipal.DataSet.RecordCount
  else
    Result := 0;
end;

procedure TFRegister.SetQtdeRegistros;
begin
  StatusBar.Panels[0].Text := 'Registros encontrados: ' + IntToStr(GetQtdeRegistros);
end;

procedure TFRegister.ConfirmSave;
begin
  if dsPrincipal.State in [dsEdit, dsInsert] then
    case MessageBox(Handle, 'Deseja salvar as alterações ?', 'Atenção', MB_ICONQUESTION + MB_YESNOCANCEL) of
      ID_YES   : btnRegSalvar.Click;
      ID_NO    : btnRegDesfazer.Click;
      ID_CANCEL: Abort;
    end;
end;

procedure TFRegister.CheckDatasetPosition;
begin
  if (GetDataSetInstanciado) and (dsPrincipal.DataSet.RecNo > 0) then
  begin
    if (dsPrincipal.DataSet.RecNo = 1) then
    begin
      btnRegAnterior.Enabled := False;
      btnRegProximo.Enabled  := False;
    end
    else if (dsPrincipal.DataSet.RecNo = dsPrincipal.DataSet.RecordCount) then
    begin
      btnRegAnterior.Enabled := True;
      btnRegProximo.Enabled  := False;
    end
    else
    begin
      btnRegAnterior.Enabled := (dsPrincipal.DataSet.RecordCount > 0);
      btnRegProximo.Enabled  := btnRegAnterior.Enabled;
    end;
  end
  else
  begin
      btnRegAnterior.Enabled := False;
      btnRegProximo.Enabled  := False;
  end;
end;

procedure TFRegister.OnAfterScroll(DataSet: TDataSet);
begin
  CheckDatasetPosition;
  MapDataSetToFields(dsPrincipal.DataSet);
end;

procedure TFRegister.OnBeforeScroll(DataSet: TDataSet);
begin
  ConfirmaSalvar;
end;

procedure TFRegister.PreviousRegister;
begin
  dsPrincipal.DataSet.Prior;
  btnRegAnterior.Enabled := (dsPrincipal.DataSet.RecNo > 1);
  btnRegProximo.Enabled  := True;
end;

procedure TFRegister.ProximoRegistro;
begin
  dsPrincipal.DataSet.Next;
  btnRegProximo.Enabled  := (dsPrincipal.DataSet.RecNo < dsPrincipal.DataSet.RecordCount);
  btnRegAnterior.Enabled := True;
end;

procedure TFRegister.NovoRegistro;
begin
  HabilitaNoInserir;
  SetStatus(stInserindo);
end;

procedure TFRegister.EditarRegistro;
begin
if GetDataSetInstanciado then
  begin
    dsPrincipal.DataSet.Edit;

    HabilitaNoAlterar;
    SetStatus(stEditando);
  end;
end;

procedure TFRegister.CancelarAlteracao;
begin
  HabilitaNoCancelar;
  SetQtdeRegistros;
end;

procedure TFRegister.ApagarRegistro;
var
  iRecNo: Integer;
begin
  if (GetDataSetInstanciado) then
  begin
    iRecNo := dsPrincipal.DataSet.RecNo;

    RefreshDataset;

    if (iRecNo > dsPrincipal.DataSet.RecordCount) then
      dsPrincipal.DataSet.RecNo := dsPrincipal.DataSet.RecordCount
    else
      dsPrincipal.DataSet.RecNo := iRecNo;
  end;

  HabilitaNoExcluir;
end;

procedure TFRegister.HabilitaNoInicializar;
begin
  btnRegAnterior.Enabled := False;
  btnRegProximo.Enabled  := True;
  btnRegEditar.Enabled   := True;
  btnRegSalvar.Enabled   := False;
  btnRegDesfazer.Enabled := False;
  btnRegApagar.Enabled   := True;
end;

procedure TFRegister.HabilitaNoInserir;
begin
  btnRegAnterior.Enabled := False;
  btnRegProximo.Enabled  := False;
  btnRegNovo.Enabled     := False;
  btnRegEditar.Enabled   := False;
  btnRegApagar.Enabled   := False;

  btnRegSalvar.Enabled   := True;
  btnRegDesfazer.Enabled := True;
end;

procedure TFRegister.HabilitaNoAlterar;
begin
  btnRegAnterior.Enabled := False;
  btnRegProximo.Enabled  := False;
  btnRegNovo.Enabled     := False;
  btnRegEditar.Enabled   := False;
  btnRegApagar.Enabled   := False;

  btnRegSalvar.Enabled   := True;
  btnRegDesfazer.Enabled := True;
end;

procedure TFRegister.HabilitaNoSalvar;
begin
  btnRegSalvar.Enabled   := False;
  btnRegDesfazer.Enabled := False;

  ChecaPosicaoDataset;

  btnRegNovo.Enabled     := True;
  btnRegEditar.Enabled   := True;
  btnRegApagar.Enabled   := True;
end;

procedure TFRegister.HabilitaNoCancelar;
begin
  if (GetDataSetInstanciado) then
  begin
    btnRegSalvar.Enabled   := False;
    btnRegDesfazer.Enabled := False;
    btnRegApagar.Enabled   := False;

    ChecaPosicaoDataset;

    btnRegNovo.Enabled     := True;
    btnRegEditar.Enabled   := True;
    btnRegApagar.Enabled   := True;
  end
  else
  begin
    btnRegAnterior.Enabled := False;
    btnRegProximo.Enabled  := False;
    btnRegEditar.Enabled   := False;
    btnRegSalvar.Enabled   := False;
    btnRegDesfazer.Enabled := False;
    btnRegApagar.Enabled   := False;

    btnRegNovo.Enabled     := True;
  end;
end;

procedure TFRegister.HabilitaNoExcluir;
begin
  ChecaPosicaoDataset;
  HabilitaNoPesquisar;
end;

procedure TFRegister.HabilitaNoPesquisar;
begin
  btnRegAnterior.Enabled := True;
  btnRegProximo.Enabled  := True;

  if (GetQtdeRegistros = 0) then
  begin
    btnRegSalvar.Enabled   := False;
    btnRegDesfazer.Enabled := False;
    btnRegApagar.Enabled   := False;
  end
  else
  begin
    btnRegNovo.Enabled   := True;
    btnRegEditar.Enabled := True;
    btnRegApagar.Enabled := True;
  end;
end;

function TFRegister.GetStatus: TStatus;
begin
  Result := FStatus;
end;

end.
